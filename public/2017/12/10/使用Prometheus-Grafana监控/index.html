<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>使用Prometheus+Grafana监控 | Graychen的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简介Prometheus（普罗米修斯）是一套开源的监控&amp;amp;报警&amp;amp;时间序列数据库的组合，起始是由SoundCloud公司开发的。随着发展，越来越多公司和组织接受采用Prometheus，社会也十分活跃，他们便将它独立成开源项目，并且有公司来运作。Google SRE的书内也曾提到跟他们BorgMon监控系统相似的实现是Prometheus。现在最常见的Kubernetes容器管理系统中">
<meta name="keywords" content="devops">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Prometheus+Grafana监控">
<meta property="og:url" content="http://graychen.git.io/2017/12/10/使用Prometheus-Grafana监控/index.html">
<meta property="og:site_name" content="Graychen的博客">
<meta property="og:description" content="简介Prometheus（普罗米修斯）是一套开源的监控&amp;amp;报警&amp;amp;时间序列数据库的组合，起始是由SoundCloud公司开发的。随着发展，越来越多公司和组织接受采用Prometheus，社会也十分活跃，他们便将它独立成开源项目，并且有公司来运作。Google SRE的书内也曾提到跟他们BorgMon监控系统相似的实现是Prometheus。现在最常见的Kubernetes容器管理系统中">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4pg7j25ej30l60dw40p.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4tb10am7j30mh093jsh.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4tbxey4xj30mo08k3zm.jpg">
<meta property="og:updated_time" content="2017-12-10T12:38:46.108Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Prometheus+Grafana监控">
<meta name="twitter:description" content="简介Prometheus（普罗米修斯）是一套开源的监控&amp;amp;报警&amp;amp;时间序列数据库的组合，起始是由SoundCloud公司开发的。随着发展，越来越多公司和组织接受采用Prometheus，社会也十分活跃，他们便将它独立成开源项目，并且有公司来运作。Google SRE的书内也曾提到跟他们BorgMon监控系统相似的实现是Prometheus。现在最常见的Kubernetes容器管理系统中">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4pg7j25ej30l60dw40p.jpg">
  
    <link rel="alternative" href="/atom.xml" title="Graychen的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/assets/blogImg/avatar.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Graychen</a></h1>
		</hgroup>

		
		<p class="header-subtitle">这个世界需要更多的英雄</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/categories/随笔">随笔</a></li>
				        
							<li><a href="/categories/技术">技术文章</a></li>
				        
							<li><a href="/categories/错误日志">错误日志</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/Graychen" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/5508881293/home?topnav=1&wvr=6" title="weibo">weibo</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/huashendung" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/devops/" style="font-size: 13.33px;">devops</a> <a href="/tags/linux/" style="font-size: 13.33px;">linux</a> <a href="/tags/linux基础/" style="font-size: 13.33px;">linux基础</a> <a href="/tags/php/" style="font-size: 20px;">php</a> <a href="/tags/php-php扩展-c/" style="font-size: 16.67px;">php php扩展 c</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/技术/" style="font-size: 10px;">技术</a> <a href="/tags/技术-php/" style="font-size: 13.33px;">技术 php</a> <a href="/tags/编辑器/" style="font-size: 13.33px;">编辑器</a> <a href="/tags/错误日志/" style="font-size: 10px;">错误日志</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Graychen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/assets/blogImg/avatar.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Graychen</h1>
			</hgroup>
			
			<p class="header-subtitle">这个世界需要更多的英雄</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/categories/随笔">随笔</a></li>
		        
					<li><a href="/categories/技术">技术文章</a></li>
		        
					<li><a href="/categories/错误日志">错误日志</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Graychen" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/5508881293/home?topnav=1&wvr=6" title="weibo">weibo</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/huashendung" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-使用Prometheus-Grafana监控" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/10/使用Prometheus-Grafana监控/" class="article-date">
  	<time datetime="2017-12-10T10:09:37.000Z" itemprop="datePublished">2017-12-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      使用Prometheus+Grafana监控
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/devops/">devops</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Prometheus（普罗米修斯）是一套开源的监控&amp;报警&amp;时间序列数据库的组合，起始是由SoundCloud公司开发的。随着发展，越来越多公司和组织接受采用Prometheus，社会也十分活跃，他们便将它独立成开源项目，并且有公司来运作。Google SRE的书内也曾提到跟他们BorgMon监控系统相似的实现是Prometheus。现在最常见的Kubernetes容器管理系统中，通常会搭配Prometheus进行监控。<br>Prometheus基本原理是通过HTTP协议周期性抓取被监控组件的状态，这样做的好处是任意组件只要提供HTTP接口就可以接入监控系统，不需要任何SDK或者其他的集成过程。这样做非常适合虚拟化环境比如VM或者Docker 。<br>Prometheus应该是为数不多的适合Docker、Mesos、Kubernetes环境的监控系统之一。</p>
<p>输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux 系统信息 (包括磁盘、内存、CPU、网络等等)，具体支持的源看：<a href="https://github.com/prometheus。" target="_blank" rel="noopener">https://github.com/prometheus。</a></p>
<p>与其他监控系统相比，Prometheus的主要特点是：</p>
<ul>
<li>一个多维数据模型（时间序列由指标名称定义和设置键/值尺寸）。</li>
<li>非常高效的存储，平均一个采样数据占~3.5bytes左右，320万的时间序列，每30秒采样，保持60天，消耗磁盘大概228G。</li>
<li>一种灵活的查询语言。</li>
<li>不依赖分布式存储，单个服务器节点。</li>
<li>时间集合通过HTTP上的PULL模型进行。</li>
<li>通过中间网关支持推送时间。</li>
<li>通过服务发现或静态配置发现目标。</li>
<li>多种模式的图形和仪表板支持。</li>
</ul>
<h2 id="Prometheus架构概览"><a href="#Prometheus架构概览" class="headerlink" title="Prometheus架构概览"></a>Prometheus架构概览</h2><p>该图说明了普罗米修斯（Prometheus）及其一些生态系统组件的整体架构：<br><img src="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4pg7j25ej30l60dw40p.jpg" alt="Prometheus架构概览"><br>它的服务过程是这样的Prometheus daemon负责定时去目标上抓取metrics(指标) 数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。</p>
<ul>
<li><p>Prometheus：支持通过配置文件、文本文件、zookeeper、Consul、DNS SRV lookup等方式指定抓取目标。支持很多方式的图表可视化，例如十分精美的Grafana，自带的Promdash，以及自身提供的模版引擎等等，还提供HTTP API的查询方式，自定义所需要的输出。</p>
</li>
<li><p>Alertmanager：是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。</p>
</li>
<li><p>PushGateway：这个组件是支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。</p>
</li>
</ul>
<h2 id="Prometheus的数据模型"><a href="#Prometheus的数据模型" class="headerlink" title="Prometheus的数据模型"></a>Prometheus的数据模型</h2><p>Prometheus从根本上所有的存储都是按时间序列去实现的，相同的metrics(指标名称) 和label(一个或多个标签) 组成一条时间序列，不同的label表示不同的时间序列。为了支持一些查询，有时还会临时产生一些时间序列存储。<br>metrics name&amp;label指标名称和标签</p>
<p>每条时间序列是由唯一的”指标名称”和一组”标签（key=value）”的形式组成。</p>
<h3 id="指标名称："><a href="#指标名称：" class="headerlink" title="指标名称："></a>指标名称：</h3><p>一般是给监测对像起一名字，例如http_requests<em>total这样，它有一些命名规则，可以包字母数字</em>之类的的。通常是以应用名称开头<em>监测对像</em>数值类型_单位这样。例如：push_total、userlogin_mysql_duration_seconds、app_memory_usage_bytes。</p>
<h3 id="标签："><a href="#标签：" class="headerlink" title="标签："></a>标签：</h3><p>就是对一条时间序列不同维度的识别了，例如一个http请求用的是POST还是GET，它的endpoint是什么，这时候就要用标签去标记了。最终形成的标识便是这样了：http_requests_total{method=”POST”,endpoint=”/api/tracks”}。</p>
<p>记住，针对http_requests_total这个metrics name无论是增加标签还是删除标签都会形成一条新的时间序列。</p>
<p>查询语句就可以跟据上面标签的组合来查询聚合结果了。</p>
<p>如果以传统数据库的理解来看这条语句，则可以考虑http_requests_total是表名，标签是字段，而timestamp是主键，还有一个float64字段是值了。（Prometheus里面所有值都是按float64存储）。</p>
<a id="more"></a>
<h2 id="Prometheus四种数据类型"><a href="#Prometheus四种数据类型" class="headerlink" title="Prometheus四种数据类型"></a>Prometheus四种数据类型</h2><h3 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h3><p>Counter用于累计值，例如记录请求次数、任务完成数、错误发生次数。一直增加，不会减少。重启进程后，会被重置。</p>
<p>例如：http_response_total{method=”GET”,endpoint=”/api/tracks”} 100，10秒后抓取http_response_total{method=”GET”,endpoint=”/api/tracks”} 100。</p>
<h3 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h3><p>Gauge常规数值，例如 温度变化、内存使用变化。可变大，可变小。重启进程后，会被重置。</p>
<p>例如： memory_usage_bytes{host=”master-01″} 100 &lt; 抓取值、memory_usage_bytes{host=”master-01″} 30、memory_usage_bytes{host=”master-01″} 50、memory_usage_bytes{host=”master-01″} 80 &lt; 抓取值。</p>
<h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p>Histogram（直方图）可以理解为柱状图的意思，常用于跟踪事件发生的规模，例如：请求耗时、响应大小。它特别之处是可以对记录的内容进行分组，提供count和sum全部值的功能。</p>
<p>例如：{小于10=5次，小于20=1次，小于30=2次}，count=7次，sum=7次的求和值。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Summary和Histogram十分相似，常用于跟踪事件发生的规模，例如：请求耗时、响应大小。同样提供 count 和 sum 全部值的功能。</p>
<p>例如：count=7次，sum=7次的值求值。</p>
<p>它提供一个quantiles的功能，可以按%比划分跟踪的结果。例如：quantile取值0.95，表示取采样值里面的95%数据。</p>
<h2 id="配置文件解析"><a href="#配置文件解析" class="headerlink" title="配置文件解析"></a>配置文件解析</h2><p>###下面的例子以这个项目为例(promethes项目)[<a href="https://mops-gitlab.lianluo.com/chenjiahui/Prometheus/tree/master" target="_blank" rel="noopener">https://mops-gitlab.lianluo.com/chenjiahui/Prometheus/tree/master</a>]</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker-compose.yml</span></div><div class="line"><span class="attr">version:</span> <span class="string">'2.0'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  prometheus:</span> </div><div class="line"><span class="attr">    image:</span> prom/prometheus:v1<span class="number">.0</span><span class="number">.1</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> ./prometheus.yml:/etc/prometheus/prometheus.yml</div><div class="line"><span class="attr">        - prometheus_data:</span>/prometheus</div><div class="line"><span class="bullet">        -</span> ./alert.rules:/etc/prometheus/alert.rules</div><div class="line"><span class="attr">    command:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">'-config.file=/etc/prometheus/prometheus.yml'</span></div><div class="line"><span class="bullet">        -</span> <span class="string">'-alertmanager.url=http://alertmanager:9093'</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">'9090:9090'</span></div><div class="line"></div><div class="line"><span class="attr">  grafana:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">"grafana/grafana:3.1.1"</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">        -</span> GF_SECURITY_ADMIN_PASSWORD=pass</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">        -</span> prometheus</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="attr">        - grafana_data:</span>/var/lib/grafana</div><div class="line"><span class="bullet">        -</span> ./alert.rules:/etc/prometheus/alert.rules</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">"3000:3000"</span></div><div class="line"></div><div class="line"><span class="attr">  alertmanager:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">"prom/alertmanager:v0.8.0"</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> ./alertmanager.yml:/alertmanager.yml</div><div class="line"><span class="attr">    command:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">'-config.file=/alertmanager.yml'</span></div><div class="line">    </div><div class="line"><span class="attr">volumes:</span></div><div class="line"><span class="attr">  prometheus_data:</span> &#123;&#125;</div><div class="line"><span class="attr">  grafana_data:</span> &#123;&#125;</div></pre></td></tr></table></figure>
<p>Prometheus内置了一个web界面，我们可通过<a href="http://monitor_host:9090进行访问：" target="_blank" rel="noopener">http://monitor_host:9090进行访问：</a><br><img src="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4tb10am7j30mh093jsh.jpg" alt=""><br>但是自带的图形工具过于简陋，grafana是他的替代品，您可以通过http：// localhost：3000 / login访问Grafana,<br><img src="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4tbxey4xj30mo08k3zm.jpg" alt=""></p>
<p>在状态页面的“配置”下方，您会看到一个“目标”部分，其中列出了“prometheus”端点。<br>这相当于scrape_configs相同的设置，job_name 并且是普罗米修斯提供的指标的来源。换句话说，普罗米修斯服务器带有一个度量端点<br>或者上面所说的出口商，它报告普罗米修斯服务器本身的统计数据。</p>
<h3 id="cAdvisor-容器数据采集"><a href="#cAdvisor-容器数据采集" class="headerlink" title="cAdvisor 容器数据采集"></a>cAdvisor 容器数据采集</h3><p>因为promethus是通过主动去指定的地址拉取数据，所以要监听的项目需要配置导出器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">cadvisor:</div><div class="line"> image: google/cadvisor</div><div class="line"> volumes:</div><div class="line">   - /:/rootfs:ro</div><div class="line">   - /var/run:/var/run:rw</div><div class="line">   - /sys:/sys:ro</div><div class="line">   - /var/lib/docker/:/var/lib/docker:ro</div><div class="line"> ports:</div><div class="line">     - &quot;8080:8080&quot;</div><div class="line"> expose:</div><div class="line">     - &quot;8080&quot;</div></pre></td></tr></table></figure>
<h3 id="prometheus-yaml-配置监听数据地址"><a href="#prometheus-yaml-配置监听数据地址" class="headerlink" title="prometheus.yaml 配置监听数据地址"></a>prometheus.yaml 配置监听数据地址</h3><p>prometheus通过在这些目标上抓取指标HTTP端点来从监控目标收集指标,监听的就是数据导出器的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"># my global config</div><div class="line">global:</div><div class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</div><div class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</div><div class="line">  # scrape_timeout is set to the global default (10s).</div><div class="line"></div><div class="line">  # Attach these labels to any time series or alerts when communicating with</div><div class="line">  # external systems (federation, remote storage, Alertmanager).</div><div class="line">  external_labels:</div><div class="line">      monitor: &apos;codelab-monitor&apos;</div><div class="line"></div><div class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</div><div class="line">rule_files:</div><div class="line">    - &apos;alert.rules&apos;</div><div class="line"></div><div class="line"># A scrape configuration containing exactly one endpoint to scrape:</div><div class="line"># Here it&apos;s Prometheus itself.</div><div class="line">scrape_configs:</div><div class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</div><div class="line">  - job_name: &apos;prometheus&apos;</div><div class="line">    #scrape_interval: 5s</div><div class="line">    # metrics_path defaults to &apos;/metrics&apos;</div><div class="line">    # scheme defaults to &apos;http&apos;.</div><div class="line"></div><div class="line">    static_configs:</div><div class="line">      - targets: [&apos;192.168.1.162:9090&apos;]</div><div class="line">        labels:</div><div class="line">          instance: prometheus</div><div class="line"></div><div class="line">  - job_name: &apos;docker-online&apos;</div><div class="line">    #scrape_interval: 5s</div><div class="line">    #scheme: http</div><div class="line">    static_configs:</div><div class="line">      - targets: [&apos;192.168.1.162:8080&apos;]</div><div class="line">        labels:</div><div class="line">         group: &apos;port&apos;</div></pre></td></tr></table></figure>
<h3 id="Alertmanager报警组件"><a href="#Alertmanager报警组件" class="headerlink" title="Alertmanager报警组件"></a>Alertmanager报警组件</h3><p>Alertmanager通过命令行flag和一个配置文件进行配置。命令行flag配置不变的系统参数、配置文件定义的禁止规则、通知路由和通知接收器。<br>要查看所有可用的命令行flag，运行alertmanager -h。<br>Alertmanager在运行时加载配置，如果不能很好的形成新的配置，更改将不会被应用，并记录错误。<br>配置文件<br>要指定加载的配置文件，需要使用-config.file标志。该文件使用YAML来完成，通过下面的描述来定义。括号内的参数是可选的，对于非列表的参数的值设置为指定的缺省值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">global:</div><div class="line">  # ResolveTimeout is the time after which an alert is declared resolved</div><div class="line">  # if it has not been updated.</div><div class="line">  [ resolve_timeout: &lt;duration&gt; | default = 5m ]</div><div class="line"></div><div class="line">  # The default SMTP From header field.</div><div class="line">  [ smtp_from: &lt;tmpl_string&gt; ]</div><div class="line">  # The default SMTP smarthost used for sending emails.</div><div class="line">  [ smtp_smarthost: &lt;string&gt; ]</div><div class="line"></div><div class="line">  # The API URL to use for Slack notifications.</div><div class="line">  [ slack_api_url: &lt;string&gt; ]</div><div class="line"></div><div class="line">  [ pagerduty_url: &lt;string&gt; | default = &quot;https://events.pagerduty.com/generic/2010-04-15/create_event.json&quot; ]</div><div class="line">  [ opsgenie_api_host: &lt;string&gt; | default = &quot;https://api.opsgenie.com/&quot; ]</div><div class="line"></div><div class="line"># Files from which custom notification template definitions are read.</div><div class="line"># The last component may use a wildcard matcher, e.g. &apos;templates/*.tmpl&apos;.</div><div class="line">templates:</div><div class="line">  [ - &lt;filepath&gt; ... ]</div><div class="line"></div><div class="line"># The root node of the routing tree.</div><div class="line">route: &lt;route&gt;</div><div class="line"></div><div class="line"># A list of notification receivers.</div><div class="line">receivers:</div><div class="line">  - &lt;receiver&gt; ...</div><div class="line"></div><div class="line"># A list of inhibition rules.</div><div class="line">inhibit_rules:</div><div class="line">  [ - &lt;inhibit_rule&gt; ... ]</div></pre></td></tr></table></figure></p>
<p>路由 route<br>路由块定义了路由树及其子节点。如果没有设置的话，子节点的可选配置参数从其父节点继承。<br>每个警报进入配置的路由树的顶级路径，顶级路径必须匹配所有警报（即没有任何形式的匹配）。然后匹配子节点。如果continue的值设置为false，它在匹配第一个孩子后就停止；如果在子节点匹配，continue的值为true，警报将继续进行后续兄弟姐妹的匹配。如果警报不匹配任何节点的任何子节点（没有匹配的子节点，或不存在），该警报基于当前节点的配置处理。<br>路由配置格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">[ receiver: &lt;string&gt; ]</div><div class="line">[ group_by: &apos;[&apos; &lt;labelname&gt;, ... &apos;]&apos; ]</div><div class="line"></div><div class="line"># Whether an alert should continue matching subsequent sibling nodes.</div><div class="line">[ continue: &lt;boolean&gt; | default = false ]</div><div class="line"></div><div class="line"># A set of equality matchers an alert has to fulfill to match the node.</div><div class="line">match:</div><div class="line">  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]</div><div class="line"></div><div class="line"># A set of regex-matchers an alert has to fulfill to match the node.</div><div class="line">match_re:</div><div class="line">  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]</div><div class="line"></div><div class="line"># How long to initially wait to send a notification for a group</div><div class="line"># of alerts. Allows to wait for an inhibiting alert to arrive or collect</div><div class="line"># more initial alerts for the same group. (Usually ~0s to few minutes.)</div><div class="line">[ group_wait: &lt;duration&gt; ]</div><div class="line"></div><div class="line"># How long to wait before sending notification about new alerts that are</div><div class="line"># in are added to a group of alerts for which an initial notification</div><div class="line"># has already been sent. (Usually ~5min or more.)</div><div class="line">[ group_interval: &lt;duration&gt; ]</div><div class="line"></div><div class="line"># How long to wait before sending a notification again if it has already</div><div class="line"># been sent successfully for an alert. (Usually ~3h or more).</div><div class="line">[ repeat_interval: &lt;duration&gt; ]</div><div class="line"></div><div class="line"># Zero or more child routes.</div><div class="line">routes:</div><div class="line">  [ - &lt;route&gt; ... ]</div></pre></td></tr></table></figure>
<p>在alertmanager这个配置文件配置任何警报报警alertmanager.yml，这看起来如下,这个例子是用slack(一款聊天工具),也可以用邮件,短信等其它方式报警：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">route:</span></div><div class="line"><span class="attr">    receiver:</span> <span class="string">'slack'</span></div><div class="line"><span class="attr">receivers:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">'slack'</span></div><div class="line"><span class="attr">      slack_configs:</span></div><div class="line"><span class="attr">          - send_resolved:</span> <span class="literal">true</span></div><div class="line"><span class="attr">            username:</span> <span class="string">'Prometheus'</span></div><div class="line"><span class="attr">            channel:</span> <span class="string">'#random'</span></div><div class="line"><span class="attr">            api_url:</span> <span class="string">'https://hooks.slack.com/services/&lt;your&gt;/&lt;stuff&gt;/&lt;here&gt;'</span></div></pre></td></tr></table></figure>
<h3 id="报警规则"><a href="#报警规则" class="headerlink" title="报警规则"></a>报警规则</h3><p>报警规则允许你定义基于Prometheus语言表达的报警条件，并发送报警通知到外部服务。<br>报警规则通过以下格式定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ALERT &lt;alert name&gt;</div><div class="line">  IF &lt;expression&gt;</div><div class="line">  [ FOR &lt;duration&gt; ]</div><div class="line">  [ LABELS &lt;label set&gt; ]</div><div class="line">  [ ANNOTATIONS &lt;label set&gt; ]</div></pre></td></tr></table></figure>
<p>FOR子句使得Prometheus等待第一个传进来的向量元素（例如高HTTP错误的实例），并计数一个警报。如果元素是active，但是没有firing的，就处于pending状态。<br>LABELS（标签）子句允许指定一组附加的标签附到警报上。现有的任何标签都会被覆盖，标签值可以被模板化。<br>ANNOTATIONS（注释）子句指定另一组未查明警报实例的标签，它们被用于存储更长的其他信息，例如警报描述或者链接，注释值可以被模板化。<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># alert.rules</div><div class="line">ALERT service_down</div><div class="line">  IF up == 0</div><div class="line">ALERT high_load</div><div class="line">  IF node_load1 &gt; 0.5</div><div class="line">  ANNOTATIONS &#123;</div><div class="line">      summary = &quot;Instance &#123;&#123; $labels.instance &#125;&#125; under high load&quot;,</div><div class="line">      description = &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; is under highload.&quot;,</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://prometheus.io" target="_blank" rel="noopener">prometheus</a></li>
<li><a href="http://grafana.org" target="_blank" rel="noopener">grafana</a></li>
<li><a href="https://sagittariusyx.github.io/2016/03/07/prometheus-alertmanager/index.html" target="_blank" rel="noopener">Prometheus监控 - Alertmanager报警模块</a></li>
<li><a href="https://www.ctl.io/developers/blog/post/monitoring-docker-services-with-prometheus/" target="_blank" rel="noopener">Monitoring Docker Services with Prometheus - CenturyLink Cloud Developer Center</a></li>
<li><a href="http://www.ywnds.com/?p=9656" target="_blank" rel="noopener">使用Prometheus+Grafana监控MySQL实践 – 运维那点事</a></li>
<li><a href="http://blog.frognew.com/2017/02/use-prometheus-on-centos7.html" target="_blank" rel="noopener">使用Prometheus监控服务器</a></li>
<li><a href="http://yunlzheng.github.io/2017/07/04/prometheus-kubernates/" target="_blank" rel="noopener">Prometheus在Kubernetes下的监控实践</a></li>
<li><a href="https://finestructure.co/blog/2016/5/16/monitoring-with-prometheus-grafana-docker-part-1" target="_blank" rel="noopener">通过Prometheus，Grafana和Docker进行监控</a></li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/03/websocket结合swoole进行wss访问/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          swoole利用websocket进行wss访问
        
      </div>
    </a>
  
  
    <a href="/2017/09/27/github自动化测试/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">github上composer自动化测试</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="使用Prometheus-Grafana监控" data-title="使用Prometheus+Grafana监控" data-url="http://graychen.git.io/2017/12/10/使用Prometheus-Grafana监控/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 Graychen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: undefined,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: undefined,
		root: /
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>