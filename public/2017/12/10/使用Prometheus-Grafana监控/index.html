<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Graychen,13780185250@sina.cn"><title>使用Prometheus+Grafana监控 · Hexo</title><meta name="description" content="简介Prometheus（普罗米修斯）是一套开源的监控&amp;amp;报警&amp;amp;时间序列数据库的组合，起始是由SoundCloud公司开发的。随着发展，越来越多公司和组织接受采用Prometheus，社会也十分活跃，他们便将它独立成开源项目，并且有公司来运作。Google SRE的书内也曾提到跟他们B"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">Hexo</a></h3><div class="description"><p>这个世界需要更多的英雄</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/huashendung"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/1763295797/home?wvr=5"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/Graychen"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="assets/blogImg/avatar.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>使用Prometheus+Grafana监控</a></h3></div><div class="post-content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Prometheus（普罗米修斯）是一套开源的监控&amp;报警&amp;时间序列数据库的组合，起始是由SoundCloud公司开发的。随着发展，越来越多公司和组织接受采用Prometheus，社会也十分活跃，他们便将它独立成开源项目，并且有公司来运作。Google SRE的书内也曾提到跟他们BorgMon监控系统相似的实现是Prometheus。现在最常见的Kubernetes容器管理系统中，通常会搭配Prometheus进行监控。<br>Prometheus基本原理是通过HTTP协议周期性抓取被监控组件的状态，这样做的好处是任意组件只要提供HTTP接口就可以接入监控系统，不需要任何SDK或者其他的集成过程。这样做非常适合虚拟化环境比如VM或者Docker 。<br>Prometheus应该是为数不多的适合Docker、Mesos、Kubernetes环境的监控系统之一。</p>
<p>输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux 系统信息 (包括磁盘、内存、CPU、网络等等)，具体支持的源看：<a href="https://github.com/prometheus。" target="_blank" rel="noopener">https://github.com/prometheus。</a></p>
<p>与其他监控系统相比，Prometheus的主要特点是：</p>
<ul>
<li>一个多维数据模型（时间序列由指标名称定义和设置键/值尺寸）。</li>
<li>非常高效的存储，平均一个采样数据占~3.5bytes左右，320万的时间序列，每30秒采样，保持60天，消耗磁盘大概228G。</li>
<li>一种灵活的查询语言。</li>
<li>不依赖分布式存储，单个服务器节点。</li>
<li>时间集合通过HTTP上的PULL模型进行。</li>
<li>通过中间网关支持推送时间。</li>
<li>通过服务发现或静态配置发现目标。</li>
<li>多种模式的图形和仪表板支持。</li>
</ul>
<h2 id="Prometheus架构概览"><a href="#Prometheus架构概览" class="headerlink" title="Prometheus架构概览"></a>Prometheus架构概览</h2><p>该图说明了普罗米修斯（Prometheus）及其一些生态系统组件的整体架构：<br><img src="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4pg7j25ej30l60dw40p.jpg" alt="Prometheus架构概览"><br>它的服务过程是这样的Prometheus daemon负责定时去目标上抓取metrics(指标) 数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。</p>
<ul>
<li><p>Prometheus：支持通过配置文件、文本文件、zookeeper、Consul、DNS SRV lookup等方式指定抓取目标。支持很多方式的图表可视化，例如十分精美的Grafana，自带的Promdash，以及自身提供的模版引擎等等，还提供HTTP API的查询方式，自定义所需要的输出。</p>
</li>
<li><p>Alertmanager：是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。</p>
</li>
<li><p>PushGateway：这个组件是支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。</p>
</li>
</ul>
<h2 id="Prometheus的数据模型"><a href="#Prometheus的数据模型" class="headerlink" title="Prometheus的数据模型"></a>Prometheus的数据模型</h2><p>Prometheus从根本上所有的存储都是按时间序列去实现的，相同的metrics(指标名称) 和label(一个或多个标签) 组成一条时间序列，不同的label表示不同的时间序列。为了支持一些查询，有时还会临时产生一些时间序列存储。<br>metrics name&amp;label指标名称和标签</p>
<p>每条时间序列是由唯一的”指标名称”和一组”标签（key=value）”的形式组成。</p>
<h3 id="指标名称："><a href="#指标名称：" class="headerlink" title="指标名称："></a>指标名称：</h3><p>一般是给监测对像起一名字，例如http_requests_total这样，它有一些命名规则，可以包字母数字<em>之类的的。通常是以应用名称开头</em>监测对像<em>数值类型</em>单位这样。例如：push_total、userlogin_mysql_duration_seconds、app_memory_usage_bytes。</p>
<h3 id="标签："><a href="#标签：" class="headerlink" title="标签："></a>标签：</h3><p>就是对一条时间序列不同维度的识别了，例如一个http请求用的是POST还是GET，它的endpoint是什么，这时候就要用标签去标记了。最终形成的标识便是这样了：http_requests_total{method=”POST”,endpoint=”/api/tracks”}。</p>
<p>记住，针对http_requests_total这个metrics name无论是增加标签还是删除标签都会形成一条新的时间序列。</p>
<p>查询语句就可以跟据上面标签的组合来查询聚合结果了。</p>
<p>如果以传统数据库的理解来看这条语句，则可以考虑http_requests_total是表名，标签是字段，而timestamp是主键，还有一个float64字段是值了。（Prometheus里面所有值都是按float64存储）。</p>
<a id="more"></a>
<h2 id="Prometheus四种数据类型"><a href="#Prometheus四种数据类型" class="headerlink" title="Prometheus四种数据类型"></a>Prometheus四种数据类型</h2><h3 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h3><p>Counter用于累计值，例如记录请求次数、任务完成数、错误发生次数。一直增加，不会减少。重启进程后，会被重置。</p>
<p>例如：http_response_total{method=”GET”,endpoint=”/api/tracks”} 100，10秒后抓取http_response_total{method=”GET”,endpoint=”/api/tracks”} 100。</p>
<h3 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h3><p>Gauge常规数值，例如 温度变化、内存使用变化。可变大，可变小。重启进程后，会被重置。</p>
<p>例如： memory_usage_bytes{host=”master-01″} 100 &lt; 抓取值、memory_usage_bytes{host=”master-01″} 30、memory_usage_bytes{host=”master-01″} 50、memory_usage_bytes{host=”master-01″} 80 &lt; 抓取值。</p>
<h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p>Histogram（直方图）可以理解为柱状图的意思，常用于跟踪事件发生的规模，例如：请求耗时、响应大小。它特别之处是可以对记录的内容进行分组，提供count和sum全部值的功能。</p>
<p>例如：{小于10=5次，小于20=1次，小于30=2次}，count=7次，sum=7次的求和值。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Summary和Histogram十分相似，常用于跟踪事件发生的规模，例如：请求耗时、响应大小。同样提供 count 和 sum 全部值的功能。</p>
<p>例如：count=7次，sum=7次的值求值。</p>
<p>它提供一个quantiles的功能，可以按%比划分跟踪的结果。例如：quantile取值0.95，表示取采样值里面的95%数据。</p>
<h2 id="配置文件解析"><a href="#配置文件解析" class="headerlink" title="配置文件解析"></a>配置文件解析</h2><p>###下面的例子以这个项目为例(promethes项目)[<a href="https://mops-gitlab.lianluo.com/chenjiahui/Prometheus/tree/master]" target="_blank" rel="noopener">https://mops-gitlab.lianluo.com/chenjiahui/Prometheus/tree/master]</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'2.0'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  prometheus:</span> </span><br><span class="line"><span class="attr">    image:</span> prom/prometheus:v1<span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">        -</span> ./prometheus.yml:/etc/prometheus/prometheus.yml</span><br><span class="line"><span class="attr">        - prometheus_data:</span>/prometheus</span><br><span class="line"><span class="bullet">        -</span> ./alert.rules:/etc/prometheus/alert.rules</span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'-config.file=/etc/prometheus/prometheus.yml'</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'-alertmanager.url=http://alertmanager:9093'</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'9090:9090'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  grafana:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">"grafana/grafana:3.1.1"</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">        -</span> GF_SECURITY_ADMIN_PASSWORD=pass</span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">        -</span> prometheus</span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">        - grafana_data:</span>/var/lib/grafana</span><br><span class="line"><span class="bullet">        -</span> ./alert.rules:/etc/prometheus/alert.rules</span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"3000:3000"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  alertmanager:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">"prom/alertmanager:v0.8.0"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">        -</span> ./alertmanager.yml:/alertmanager.yml</span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'-config.file=/alertmanager.yml'</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  prometheus_data:</span> &#123;&#125;</span><br><span class="line"><span class="attr">  grafana_data:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>Prometheus内置了一个web界面，我们可通过<a href="http://monitor_host:9090进行访问：" target="_blank" rel="noopener">http://monitor_host:9090进行访问：</a><br><img src="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4tb10am7j30mh093jsh.jpg" alt><br>但是自带的图形工具过于简陋，grafana是他的替代品，您可以通过http：// localhost：3000 / login访问Grafana,<br><img src="http://ww1.sinaimg.cn/large/0060OHG5gy1fm4tbxey4xj30mo08k3zm.jpg" alt></p>
<p>在状态页面的“配置”下方，您会看到一个“目标”部分，其中列出了“prometheus”端点。<br>这相当于scrape_configs相同的设置，job_name 并且是普罗米修斯提供的指标的来源。换句话说，普罗米修斯服务器带有一个度量端点<br>或者上面所说的出口商，它报告普罗米修斯服务器本身的统计数据。</p>
<h3 id="cAdvisor-容器数据采集"><a href="#cAdvisor-容器数据采集" class="headerlink" title="cAdvisor 容器数据采集"></a>cAdvisor 容器数据采集</h3><p>因为promethus是通过主动去指定的地址拉取数据，所以要监听的项目需要配置导出器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cadvisor:</span><br><span class="line"> image: google/cadvisor</span><br><span class="line"> volumes:</span><br><span class="line">   - /:/rootfs:ro</span><br><span class="line">   - /var/run:/var/run:rw</span><br><span class="line">   - /sys:/sys:ro</span><br><span class="line">   - /var/lib/docker/:/var/lib/docker:ro</span><br><span class="line"> ports:</span><br><span class="line">     - &quot;8080:8080&quot;</span><br><span class="line"> expose:</span><br><span class="line">     - &quot;8080&quot;</span><br></pre></td></tr></table></figure>
<h3 id="prometheus-yaml-配置监听数据地址"><a href="#prometheus-yaml-配置监听数据地址" class="headerlink" title="prometheus.yaml 配置监听数据地址"></a>prometheus.yaml 配置监听数据地址</h3><p>prometheus通过在这些目标上抓取指标HTTP端点来从监控目标收集指标,监听的就是数据导出器的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line">  # Attach these labels to any time series or alerts when communicating with</span><br><span class="line">  # external systems (federation, remote storage, Alertmanager).</span><br><span class="line">  external_labels:</span><br><span class="line">      monitor: &apos;codelab-monitor&apos;</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">rule_files:</span><br><span class="line">    - &apos;alert.rules&apos;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&apos;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line">    #scrape_interval: 5s</span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.1.162:9090&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: prometheus</span><br><span class="line"></span><br><span class="line">  - job_name: &apos;docker-online&apos;</span><br><span class="line">    #scrape_interval: 5s</span><br><span class="line">    #scheme: http</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.1.162:8080&apos;]</span><br><span class="line">        labels:</span><br><span class="line">         group: &apos;port&apos;</span><br></pre></td></tr></table></figure>
<h3 id="Alertmanager报警组件"><a href="#Alertmanager报警组件" class="headerlink" title="Alertmanager报警组件"></a>Alertmanager报警组件</h3><p>Alertmanager通过命令行flag和一个配置文件进行配置。命令行flag配置不变的系统参数、配置文件定义的禁止规则、通知路由和通知接收器。<br>要查看所有可用的命令行flag，运行alertmanager -h。<br>Alertmanager在运行时加载配置，如果不能很好的形成新的配置，更改将不会被应用，并记录错误。<br>配置文件<br>要指定加载的配置文件，需要使用-config.file标志。该文件使用YAML来完成，通过下面的描述来定义。括号内的参数是可选的，对于非列表的参数的值设置为指定的缺省值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  # ResolveTimeout is the time after which an alert is declared resolved</span><br><span class="line">  # if it has not been updated.</span><br><span class="line">  [ resolve_timeout: &lt;duration&gt; | default = 5m ]</span><br><span class="line"></span><br><span class="line">  # The default SMTP From header field.</span><br><span class="line">  [ smtp_from: &lt;tmpl_string&gt; ]</span><br><span class="line">  # The default SMTP smarthost used for sending emails.</span><br><span class="line">  [ smtp_smarthost: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line">  # The API URL to use for Slack notifications.</span><br><span class="line">  [ slack_api_url: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line">  [ pagerduty_url: &lt;string&gt; | default = &quot;https://events.pagerduty.com/generic/2010-04-15/create_event.json&quot; ]</span><br><span class="line">  [ opsgenie_api_host: &lt;string&gt; | default = &quot;https://api.opsgenie.com/&quot; ]</span><br><span class="line"></span><br><span class="line"># Files from which custom notification template definitions are read.</span><br><span class="line"># The last component may use a wildcard matcher, e.g. &apos;templates/*.tmpl&apos;.</span><br><span class="line">templates:</span><br><span class="line">  [ - &lt;filepath&gt; ... ]</span><br><span class="line"></span><br><span class="line"># The root node of the routing tree.</span><br><span class="line">route: &lt;route&gt;</span><br><span class="line"></span><br><span class="line"># A list of notification receivers.</span><br><span class="line">receivers:</span><br><span class="line">  - &lt;receiver&gt; ...</span><br><span class="line"></span><br><span class="line"># A list of inhibition rules.</span><br><span class="line">inhibit_rules:</span><br><span class="line">  [ - &lt;inhibit_rule&gt; ... ]</span><br></pre></td></tr></table></figure></p>
<p>路由 route<br>路由块定义了路由树及其子节点。如果没有设置的话，子节点的可选配置参数从其父节点继承。<br>每个警报进入配置的路由树的顶级路径，顶级路径必须匹配所有警报（即没有任何形式的匹配）。然后匹配子节点。如果continue的值设置为false，它在匹配第一个孩子后就停止；如果在子节点匹配，continue的值为true，警报将继续进行后续兄弟姐妹的匹配。如果警报不匹配任何节点的任何子节点（没有匹配的子节点，或不存在），该警报基于当前节点的配置处理。<br>路由配置格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[ receiver: &lt;string&gt; ]</span><br><span class="line">[ group_by: &apos;[&apos; &lt;labelname&gt;, ... &apos;]&apos; ]</span><br><span class="line"></span><br><span class="line"># Whether an alert should continue matching subsequent sibling nodes.</span><br><span class="line">[ continue: &lt;boolean&gt; | default = false ]</span><br><span class="line"></span><br><span class="line"># A set of equality matchers an alert has to fulfill to match the node.</span><br><span class="line">match:</span><br><span class="line">  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]</span><br><span class="line"></span><br><span class="line"># A set of regex-matchers an alert has to fulfill to match the node.</span><br><span class="line">match_re:</span><br><span class="line">  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]</span><br><span class="line"></span><br><span class="line"># How long to initially wait to send a notification for a group</span><br><span class="line"># of alerts. Allows to wait for an inhibiting alert to arrive or collect</span><br><span class="line"># more initial alerts for the same group. (Usually ~0s to few minutes.)</span><br><span class="line">[ group_wait: &lt;duration&gt; ]</span><br><span class="line"></span><br><span class="line"># How long to wait before sending notification about new alerts that are</span><br><span class="line"># in are added to a group of alerts for which an initial notification</span><br><span class="line"># has already been sent. (Usually ~5min or more.)</span><br><span class="line">[ group_interval: &lt;duration&gt; ]</span><br><span class="line"></span><br><span class="line"># How long to wait before sending a notification again if it has already</span><br><span class="line"># been sent successfully for an alert. (Usually ~3h or more).</span><br><span class="line">[ repeat_interval: &lt;duration&gt; ]</span><br><span class="line"></span><br><span class="line"># Zero or more child routes.</span><br><span class="line">routes:</span><br><span class="line">  [ - &lt;route&gt; ... ]</span><br></pre></td></tr></table></figure>
<p>在alertmanager这个配置文件配置任何警报报警alertmanager.yml，这看起来如下,这个例子是用slack(一款聊天工具),也可以用邮件,短信等其它方式报警：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="attr">    receiver:</span> <span class="string">'slack'</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">'slack'</span></span><br><span class="line"><span class="attr">      slack_configs:</span></span><br><span class="line"><span class="attr">          - send_resolved:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            username:</span> <span class="string">'Prometheus'</span></span><br><span class="line"><span class="attr">            channel:</span> <span class="string">'#random'</span></span><br><span class="line"><span class="attr">            api_url:</span> <span class="string">'https://hooks.slack.com/services/&lt;your&gt;/&lt;stuff&gt;/&lt;here&gt;'</span></span><br></pre></td></tr></table></figure>
<h3 id="报警规则"><a href="#报警规则" class="headerlink" title="报警规则"></a>报警规则</h3><p>报警规则允许你定义基于Prometheus语言表达的报警条件，并发送报警通知到外部服务。<br>报警规则通过以下格式定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ALERT &lt;alert name&gt;</span><br><span class="line">  IF &lt;expression&gt;</span><br><span class="line">  [ FOR &lt;duration&gt; ]</span><br><span class="line">  [ LABELS &lt;label set&gt; ]</span><br><span class="line">  [ ANNOTATIONS &lt;label set&gt; ]</span><br></pre></td></tr></table></figure>
<p>FOR子句使得Prometheus等待第一个传进来的向量元素（例如高HTTP错误的实例），并计数一个警报。如果元素是active，但是没有firing的，就处于pending状态。<br>LABELS（标签）子句允许指定一组附加的标签附到警报上。现有的任何标签都会被覆盖，标签值可以被模板化。<br>ANNOTATIONS（注释）子句指定另一组未查明警报实例的标签，它们被用于存储更长的其他信息，例如警报描述或者链接，注释值可以被模板化。<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># alert.rules</span><br><span class="line">ALERT service_down</span><br><span class="line">  IF up == 0</span><br><span class="line">ALERT high_load</span><br><span class="line">  IF node_load1 &gt; 0.5</span><br><span class="line">  ANNOTATIONS &#123;</span><br><span class="line">      summary = &quot;Instance &#123;&#123; $labels.instance &#125;&#125; under high load&quot;,</span><br><span class="line">      description = &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; is under highload.&quot;,</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://prometheus.io" target="_blank" rel="noopener">prometheus</a></li>
<li><a href="http://grafana.org" target="_blank" rel="noopener">grafana</a></li>
<li><a href="https://sagittariusyx.github.io/2016/03/07/prometheus-alertmanager/index.html" target="_blank" rel="noopener">Prometheus监控 - Alertmanager报警模块</a></li>
<li><a href="https://www.ctl.io/developers/blog/post/monitoring-docker-services-with-prometheus/" target="_blank" rel="noopener">Monitoring Docker Services with Prometheus - CenturyLink Cloud Developer Center</a></li>
<li><a href="http://www.ywnds.com/?p=9656" target="_blank" rel="noopener">使用Prometheus+Grafana监控MySQL实践 – 运维那点事</a></li>
<li><a href="http://blog.frognew.com/2017/02/use-prometheus-on-centos7.html" target="_blank" rel="noopener">使用Prometheus监控服务器</a></li>
<li><a href="http://yunlzheng.github.io/2017/07/04/prometheus-kubernates/" target="_blank" rel="noopener">Prometheus在Kubernetes下的监控实践</a></li>
<li><a href="https://finestructure.co/blog/2016/5/16/monitoring-with-prometheus-grafana-docker-part-1" target="_blank" rel="noopener">通过Prometheus，Grafana和Docker进行监控</a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-10</span><i class="fa fa-tag"></i><a class="tag" href="/tags/devops/" title="devops">devops </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2017/12/10/使用Prometheus-Grafana监控/,Hexo,使用Prometheus+Grafana监控,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/01/03/websocket结合swoole进行wss访问/" title="swoole利用websocket进行wss访问">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/09/27/github自动化测试/" title="github上composer自动化测试">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>