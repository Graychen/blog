<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Graychen,13780185250@sina.cn"><title>github上composer自动化测试 · Hexo</title><meta name="description" content="前段时间我们组对项目进行重构，将多个项目中例如log，app的更新这些重复的内容抽出来做了composer包，为了保证这些composer包的代码质量，使用了github上的一些工具。下面我以自己的一个利用经纬度查询地理位置的composer包geolocation[https://github.c"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">Hexo</a></h3><div class="description"><p>这个世界需要更多的英雄</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/huashendung"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/1763295797/home?wvr=5"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/Graychen"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="assets/blogImg/avatar.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>github上composer自动化测试</a></h3></div><div class="post-content"><p>前段时间我们组对项目进行重构，将多个项目中例如log，app的更新这些重复的内容抽出来做了composer包，为了保证这些composer包的代码质量，<br>使用了github上的一些工具。下面我以自己的一个利用经纬度查询地理位置的composer包geolocation[<a href="https://github.com/Graychen/geolocation/tree/master/tests]为例来详细描述下我们的做法。" target="_blank" rel="noopener">https://github.com/Graychen/geolocation/tree/master/tests]为例来详细描述下我们的做法。</a></p>
<h2 id="Style-CI-php格式检查"><a href="#Style-CI-php格式检查" class="headerlink" title="Style CI(php格式检查)"></a>Style CI(php格式检查)</h2><p>在项目根目录，新建.styleci.yml 配置文件，并编写配置内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preset: psr2</span><br></pre></td></tr></table></figure></p>
<p>打开 <a href="https://styleci.io/" target="_blank" rel="noopener">https://styleci.io/</a> ，使用Gitlab账号登录，找到对应的项目，点击右侧的 ENABLE STYLECI 启用按钮，即可使用，<br>每次提交代码，都会看到检测结果<br>如果没有找到自己的项目，打开 <a href="https://styleci.io/account#repos" target="_blank" rel="noopener">https://styleci.io/account#repos</a> 点击 Sync With GitHub 同步，就会看到</p>
<h2 id="Travis-CI-自动化测试"><a href="#Travis-CI-自动化测试" class="headerlink" title="Travis-CI(自动化测试)"></a>Travis-CI(自动化测试)</h2><h3 id="配置单元测试"><a href="#配置单元测试" class="headerlink" title="配置单元测试"></a>配置单元测试</h3><p>1先引入phpunit单元测试包,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require --dev phpunit/phpunit ^6.2</span><br></pre></td></tr></table></figure></p>
<p>2编写配置文件phpunit.xml.dist,放到根根根目录<br>白名单是你要测试的目录文件，用于生成代码覆盖率<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;phpunit bootstrap=&quot;./tests/bootstrap.php&quot;</span><br><span class="line">         colors=&quot;true&quot;</span><br><span class="line">         verbose=&quot;true&quot;</span><br><span class="line">         convertErrorsToExceptions=&quot;true&quot;</span><br><span class="line">         convertNoticesToExceptions=&quot;true&quot;</span><br><span class="line">         convertWarningsToExceptions=&quot;true&quot;</span><br><span class="line">         processIsolation=&quot;false&quot;</span><br><span class="line">         stopOnFailure=&quot;false&quot;&gt;</span><br><span class="line">    &lt;testsuites&gt;</span><br><span class="line">        &lt;testsuite name=&quot;Test Suite&quot;&gt;</span><br><span class="line">            &lt;directory&gt;./tests&lt;/directory&gt;</span><br><span class="line">        &lt;/testsuite&gt;</span><br><span class="line">    &lt;/testsuites&gt;</span><br><span class="line">    &lt;filter&gt;</span><br><span class="line">        &lt;whitelist&gt;</span><br><span class="line">            &lt;directory suffix=&quot;.php&quot;&gt;./src&lt;/directory&gt;</span><br><span class="line">        &lt;/whitelist&gt;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line">&lt;/phpunit&gt;</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>3然后建立测试目录test，并在里面建立bootstrap.php来引入composer中的引导文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// ensure we get report on all possible php errors</span></span><br><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>);</span><br></pre></td></tr></table></figure></p>
<p>4composerjson.json文件里自动载入,否则找不到tests里面的TestCase<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;autoload-dev&quot;: &#123;</span><br><span class="line">       &quot;psr-4&quot;: &#123;</span><br><span class="line">           &quot;graychen\\Test\\&quot;: &quot;tests/&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure></p>
<p>5编写.travil.yml文件(在<a href="https://travis-ci.com/" target="_blank" rel="noopener">https://travis-ci.com/</a> 注册账号,然后在github添加service,这样每次提交代码就会自动同步到travis)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">php:</span><br><span class="line">  - 5.6</span><br><span class="line"></span><br><span class="line">  - 7.1</span><br><span class="line"></span><br><span class="line"> # cache vendor dirs</span><br><span class="line">cache:</span><br><span class="line">  directories:</span><br><span class="line">    - $HOME/.composer/cache</span><br><span class="line">    - vendor</span><br><span class="line"></span><br><span class="line">#安装依赖</span><br><span class="line">install:</span><br><span class="line"></span><br><span class="line">  - travis_retry composer self-update</span><br><span class="line"></span><br><span class="line">  - travis_retry composer install --prefer-dist --no-interaction</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">before_script:</span><br><span class="line"></span><br><span class="line">  - travis_retry composer self-update</span><br><span class="line"></span><br><span class="line">  - travis_retry composer install --no-interaction --prefer-source --dev</span><br><span class="line"></span><br><span class="line">#单元测试</span><br><span class="line">script:</span><br><span class="line"></span><br><span class="line">  - phpunit --coverage-text --coverage-clover=coverage.clover --debug</span><br><span class="line"></span><br><span class="line">#需要在https://scrutinizer-ci.com注册账号 并绑定github账号同步github项目</span><br><span class="line">after_script:</span><br><span class="line"></span><br><span class="line">  - wget https://scrutinizer-ci.com/ocular.phar</span><br><span class="line"></span><br><span class="line">  - php ocular.phar code-coverage:upload  --format=php-clover coverage.clover</span><br></pre></td></tr></table></figure>
<h2 id="Scrutinizer-（单元测试覆盖率）"><a href="#Scrutinizer-（单元测试覆盖率）" class="headerlink" title="Scrutinizer （单元测试覆盖率）"></a>Scrutinizer （单元测试覆盖率）</h2><p>Scrutinizer具有可用于PHP代码的最先进的静态分析引擎。 它能跟踪数据如何流经我们的应用程序以检测代码安全，错误，未使用的代码等。默认情况下，Scrutinizer将分析项目中以.php结尾的所有文件。</p>
<p>1.Scrutinizer测试以后会有三个指标供我们对代码来改进</p>
<p>Code Quality</p>
<p>   代码质量评测来源主要是代码耦合度,代码的复杂度,冗余,未使用变量等.<br>Code Coverage</p>
<p>  提高单元测试覆盖率， 如果方法里有多个条件分支，尽可能传递不同参数或者使用其它方法让每一行都执行<br>Build Status</p>
<p>  这一项由代码分析来决定，比如依赖是否可以加载，测试报告是否接收到（travis-ci提供）<br>  如果travis-ci已经build成功，Scrutinizer中却因为某些依赖无法加载可通过以下配置来过滤依赖分析<br>  excluded_dependencies:</p>
<pre><code>- phpunit/php-timer
- or-another/package-name
</code></pre><p>2.基本配置文件</p>
<p>   #测试项目根目录创建.scrutinizer.yml文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">imports:</span><br><span class="line">      - php</span><br><span class="line"> tools:</span><br><span class="line">     external_code_coverage:</span><br><span class="line">         timeout: 1800 # Timeout in seconds.</span><br><span class="line">     # disable copy paste detector and similarity analyzer as they have no real value</span><br><span class="line">     # and a huge bunch of false-positives</span><br><span class="line">     php_sim: false</span><br><span class="line">     php_cpd: false</span><br></pre></td></tr></table></figure></p>
<p>参考文档地址<a href="https://scrutinizer-ci.com/docs/guides/php/automated-code-reviews" target="_blank" rel="noopener">https://scrutinizer-ci.com/docs/guides/php/automated-code-reviews</a></p>
<h2 id="Codeclimate简介及使用-漏洞排查"><a href="#Codeclimate简介及使用-漏洞排查" class="headerlink" title="Codeclimate简介及使用 (漏洞排查)"></a>Codeclimate简介及使用 (漏洞排查)</h2><p>Code Climate可以看作是开发团队的云机器人，无需执行代码就可对代码进行标准化测试，为项目提供静态分析功能，与GitHub集成可以进行漏洞排查工作 每个人都可能用正确的风格写出质量低下的代码，这其中可能包括：</p>
<p>重复的代码，它们可能存在于同一个类或不同类中<br>不一致或没有标识性的对象、变量或方法命名<br>过长的代码段<br>让人费解的布尔表达式<br>过于复杂的逻辑判断<br>对象错误地暴露其内部状态<br>遭废弃但没有删除的类或方法 Code Climate可以帮我们 Review 这部分代码</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>首先在项目中添加配置文件 。codeclimate.yml配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">engines:</span><br><span class="line">  duplication:</span><br><span class="line">    enabled: true</span><br><span class="line">    config:</span><br><span class="line">      languages:</span><br><span class="line">      - php</span><br><span class="line">  eslint:</span><br><span class="line">    enabled: true</span><br><span class="line">  fixme:</span><br><span class="line">    enabled: true</span><br><span class="line">  phpmd:</span><br><span class="line">    enabled: true</span><br><span class="line">    config:</span><br><span class="line">    checks:</span><br><span class="line">      UnusedLocalVariable:</span><br><span class="line">        enabled: false</span><br><span class="line">ratings:</span><br><span class="line">  paths:</span><br><span class="line">  - &quot;**.php&quot;</span><br><span class="line">exclude_paths:</span><br><span class="line">- tests/</span><br></pre></td></tr></table></figure></p>
<p>配置分析</p>
<p>引擎通道将您的分析映射到引擎的特定发行版本。例如，发动机可具有四个可用信道：stable，alpha，v1，和v2。未指定，分析运行发动机的稳定通道。</p>
<p>engines:<br>  some-engine:<br>    enabled: true<br>    channel: “new-hotness”<br>Github 集成<br>1首先登录[climatecode网站]<a href="https://codeclimate.com/dashboard" target="_blank" rel="noopener">https://codeclimate.com/dashboard</a><br>2 添加仓库<br>3入库<br>4显示成功,这些是分析数据</p>
<h2 id="github徽章-测试保证"><a href="#github徽章-测试保证" class="headerlink" title="github徽章 (测试保证)"></a>github徽章 (测试保证)</h2><p>修改README.md 在工具页面找这些徽章<br><a href="https://packagist.org/packages/graychen/geolocation" target="_blank" rel="noopener"><img src="https://poser.pugx.org/graychen/geolocation/version" alt="Latest Stable Version"></a><br><a href="https://packagist.org/packages/graychen/geolocation" target="_blank" rel="noopener"><img src="https://poser.pugx.org/graychen/geolocation/downloads" alt="Total Downloads"></a><br><a href="https://packagist.org/packages/graychen/geolocation" target="_blank" rel="noopener"><img src="https://poser.pugx.org/graychen/geolocation/license" alt="License"></a><br><a href="https://styleci.io/repos/92368125" target="_blank" rel="noopener"><img src="https://styleci.io/repos/92368125/shield?branch=master" alt="StyleCI"></a><br><a href="https://travis-ci.org/Graychen/yii2-post" target="_blank" rel="noopener"><img src="https://travis-ci.org/Graychen/yii2-post.svg?branch=master" alt="Build Status"></a><br><a href="https://scrutinizer-ci.com/g/Graychen/geolocation/?branch=master" target="_blank" rel="noopener"><img src="https://scrutinizer-ci.com/g/Graychen/geolocation/badges/quality-score.png?b=master" alt="Scrutinizer Code Quality"></a><br><a href="https://scrutinizer-ci.com/g/Graychen/geolocation/?branch=master" target="_blank" rel="noopener"><img src="https://scrutinizer-ci.com/g/Graychen/geolocation/badges/coverage.png?b=master" alt="Code Coverage"></a><br><a href="https://scrutinizer-ci.com/g/Graychen/geolocation/build-status/master" target="_blank" rel="noopener"><img src="https://scrutinizer-ci.com/g/Graychen/geolocation/badges/build.png?b=master" alt="Build Status"></a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-09-27</span><i class="fa fa-tag"></i><a class="tag" href="/tags/技术-php/" title="技术 php">技术 php </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2017/09/27/github自动化测试/,Hexo,github上composer自动化测试,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/12/10/使用Prometheus-Grafana监控/" title="使用Prometheus+Grafana监控">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/07/28/yii2-queue队列的使用说明/" title="yii2-queue队列的使用说明">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>